<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Exploring the different options that envoy provides and how it forms the basics of service meshes"><title>Dabbling with envoy - Part II</title>
<link rel=canonical href=https://ishankhare.dev/p/dabbling-with-envoy-configurations-part-ii/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Dabbling with envoy - Part II"><meta property='og:description' content="Exploring the different options that envoy provides and how it forms the basics of service meshes"><meta property='og:url' content='https://ishankhare.dev/p/dabbling-with-envoy-configurations-part-ii/'><meta property='og:site_name' content='Ishan Khare'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='envoy'><meta property='article:tag' content='reverseproxy'><meta property='article:tag' content='servicemesh'><meta property='article:tag' content='istio'><meta property='article:tag' content='golang'><meta property='article:published_time' content='2022-01-14T00:00:00+00:00'><meta property='article:modified_time' content='2022-01-14T00:00:00+00:00'><meta property='og:image' content='https://ishankhare.dev/p/dabbling-with-envoy-configurations-part-ii/PXL_20211114_102320720.jpg'><meta name=twitter:site content="@https://twitter.com/ishankhare07"><meta name=twitter:creator content="@https://twitter.com/ishankhare07"><meta name=twitter:title content="Dabbling with envoy - Part II"><meta name=twitter:description content="Exploring the different options that envoy provides and how it forms the basics of service meshes"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://ishankhare.dev/p/dabbling-with-envoy-configurations-part-ii/PXL_20211114_102320720.jpg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu8020bdaeac997584d241415dc4f6c363_232442_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ðŸ˜Ž</span></figure><div class=site-meta><h1 class=site-name><a href=/>Ishan Khare</a></h1><h2 class=site-description>Senior Software Engineer | Cloud Native | kubernetes | go | AI</h2></div></header><ol class=menu-social><li><a href=https://github.com/ishankhare07 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ishankhare07 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#dynamic-configuration-from-control-plane>Dynamic configuration from control plane</a><ol><li><a href=#node>node</a></li><li><a href=#dynamic_resources>dynamic_resources</a></li><li><a href=#static_resources>static_resources</a></li></ol></li><li><a href=#control-plane>Control Plane</a><ol><li><a href=#cluster-and-endpoint>Cluster and Endpoint</a></li><li><a href=#route>Route</a></li><li><a href=#listener-connection-manager-and-config-source>Listener, connection manager and config source</a></li><li><a href=#setting-up-the-grpc-services>Setting up the gRPC services</a></li><li><a href=#running-the-envoy-proxy>Running the envoy proxy</a></li><li><a href=#running-everything>Running everything</a></li><li><a href=#what-next>What next?!</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/dabbling-with-envoy-configurations-part-ii/><img src=/p/dabbling-with-envoy-configurations-part-ii/PXL_20211114_102320720_hu082ecdbb90ad1c64e25ff84bfc0ff1a8_2983891_800x0_resize_q75_box.jpg srcset="/p/dabbling-with-envoy-configurations-part-ii/PXL_20211114_102320720_hu082ecdbb90ad1c64e25ff84bfc0ff1a8_2983891_800x0_resize_q75_box.jpg 800w, /p/dabbling-with-envoy-configurations-part-ii/PXL_20211114_102320720_hu082ecdbb90ad1c64e25ff84bfc0ff1a8_2983891_1600x0_resize_q75_box.jpg 1600w" width=800 height=600 loading=lazy alt="Featured image of post Dabbling with envoy - Part II"></a></div><div class=article-details><header class=article-category><a href=/categories/servicemesh/>Servicemesh</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/dabbling-with-envoy-configurations-part-ii/>Dabbling with envoy - Part II</a></h2><h3 class=article-subtitle>Exploring the different options that envoy provides and how it forms the basics of service meshes</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 14, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>15 minute read</time></div></footer></div></header><section class=article-content><h2 id=dynamic-configuration-from-control-plane>Dynamic configuration from control plane</h2><p>There are already some production ready control planes available like</p><ol><li>Gloo</li><li>Istio</li></ol><p>We are going to experiment with what&rsquo;s at the core of these service meshes - <a class=link href=https://github.com/envoyproxy/go-control-plane target=_blank rel=noopener>Go control plane</a></p><p>In order to tell envoy where to look for the control plane for getting the configuration we need some of the following things:</p><ol><li><a class=link href=https://www.envoyproxy.io/docs/envoy/v1.20.1/start/quick-start/configuration-dynamic-control-plane#start-quick-start-dynamic-node target=_blank rel=noopener>node</a></li><li><a class=link href=https://www.envoyproxy.io/docs/envoy/v1.20.1/start/quick-start/configuration-dynamic-control-plane#start-quick-start-dynamic-dynamic-resources target=_blank rel=noopener>dynamic_resources</a></li><li><a class=link href=https://www.envoyproxy.io/docs/envoy/v1.20.1/start/quick-start/configuration-dynamic-control-plane#start-quick-start-dynamic-static-resources target=_blank rel=noopener>static_resources</a></li></ol><hr><h3 id=node>node</h3><p>The node configuration remains the same as in the previous setup of the envoy configurations:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>node</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>test-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>test-id</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=dynamic_resources>dynamic_resources</h3><p>This tells envoy which configurations to update dynamically</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dynamic_resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ads_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>api_type</span><span class=p>:</span><span class=w> </span><span class=l>GRPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>transport_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>grpc_services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envoy_grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cluster_name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cds_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ads</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lds_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ads</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>This basically tells envoy that the <code>Cluster Discovery Service</code> and the <code>Listener Discovery Service</code> are being served as part of the <code>ADS</code> (<code>Aggregate Discovery Service</code>). The <code>ads</code> configuration itself is a GRPC api served by a <code>cluster</code> named <code>xds_cluster</code>.</p><h3 id=static_resources>static_resources</h3><p>This will tell envoy where to receive its dynamic configuration from, i.e. where to find the control plane</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>static_resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>STRICT_DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>typed_extension_protocol_options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;@type&#34;: </span><span class=l>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>explicit_http_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>http2_protocol_options</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http2_protocol_options</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connect_timeout</span><span class=p>:</span><span class=w> </span><span class=l>3s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>load_assignment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cluster_name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lb_endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>socket_address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port_value</span><span class=p>:</span><span class=w> </span><span class=m>18000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Here we define the details of where can envoy find the previously specified <code>xds_cluster</code> serving the <code>ADS</code> configuration.</p><p>This is the basic configuration that we need to bootstrap our envoy instance to connect to our control plane and start getting updated configuration from it. The main advantage of this pattern over the previously described ones is that we can now take advantage of the powerful programmable API of the control plane and update the configuration programmatically. So lets see ho we can get this done.</p><h2 id=control-plane>Control Plane</h2><p>At the heart of the control place configuration, there&rsquo;s what envoy calls a <code>Snapshot</code>. Going through the envoy docs, this is what the definition of a snapshot says it is:</p><blockquote><p>Snapshot is an internally consistent snapshot of xDS resources</p></blockquote><p>And what does the <code>Snapshot</code> look like you may ask?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Snapshot</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Resources</span> <span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>UnknownType</span><span class=p>]</span><span class=nx>Resources</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// VersionMap holds the current hash map of all resources in the snapshot.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This field should remain nil until it is used, at which point should be
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// instantiated by calling ConstructVersionMap().
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// VersionMap is only to be used with delta xDS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>VersionMap</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hmm, that isn&rsquo;t very helpful. It doesn&rsquo;t give us much information about what does the <code>Resources</code> hold. On further examiniation of the docs, I found the following method in the <a class=link href=https://pkg.go.dev/github.com/envoyproxy/go-control-plane/pkg/cache/v3 target=_blank rel=noopener>cache package</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewSnapshot</span><span class=p>(</span><span class=nx>version</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>resources</span> <span class=kd>map</span><span class=p>[</span><span class=nx>resource</span><span class=p>.</span><span class=nx>Type</span><span class=p>][]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>)</span> <span class=p>(</span><span class=nx>Snapshot</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>And examining the <a class=link href=https://pkg.go.dev/github.com/envoyproxy/go-control-plane@v0.10.1/pkg/resource/v3 target=_blank rel=noopener>resource</a> package we get these constants</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>EndpointType</span>        <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.endpoint.v3.ClusterLoadAssignment&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ClusterType</span>         <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.cluster.v3.Cluster&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>RouteType</span>           <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.route.v3.RouteConfiguration&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ScopedRouteType</span>     <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.route.v3.ScopedRouteConfiguration&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ListenerType</span>        <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.listener.v3.Listener&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>SecretType</span>          <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>ExtensionConfigType</span> <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.config.core.v3.TypedExtensionConfig&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>RuntimeType</span>         <span class=p>=</span> <span class=nx>apiTypePrefix</span> <span class=o>+</span> <span class=s>&#34;envoy.service.runtime.v3.Runtime&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// AnyType is used only by ADS
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>AnyType</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>So now it makes sense â€“ the snapshot is just a fancy register that will store a point-in-time snapshot of the envoy configuration for different envoy resources like <code>listener</code>, <code>route</code>, <code>endpoint</code> etc. This is good but is there anything better? â€“ a better abstraction that we can probably use? It turns out there is. On further examination I found the <a class=link href=https://pkg.go.dev/github.com/envoyproxy/go-control-plane/pkg/cache/v3#SnapshotCache target=_blank rel=noopener>SnapshotCache</a> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SnapshotCache</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>SetSnapshot</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>node</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>snapshot</span> <span class=nx>Snapshot</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>GetSnapshot</span><span class=p>(</span><span class=nx>node</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Snapshot</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>ClearSnapshot</span><span class=p>(</span><span class=nx>node</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>GetStatusInfo</span><span class=p>(</span><span class=kt>string</span><span class=p>)</span> <span class=nx>StatusInfo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>GetStatusKeys</span><span class=p>()</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewSnapshotCache</span><span class=p>(</span><span class=nx>ads</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>hash</span> <span class=nx>NodeHash</span><span class=p>,</span> <span class=nx>logger</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=nx>SnapshotCache</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>SnapshotCache is a snapshot-based cache that maintains a single versioned snapshot of responses per node. SnapshotCache consistently replies with the latest snapshot</p></blockquote><p>Alright now we have some idea of the structure we want to put around this thing:</p><p><img src=/p/dabbling-with-envoy-configurations-part-ii/basic_struct.png width=501 height=271 srcset="/p/dabbling-with-envoy-configurations-part-ii/basic_struct_huc3b1a72eb14e80f86cf6e779c6ca28c2_3620_480x0_resize_box_3.png 480w, /p/dabbling-with-envoy-configurations-part-ii/basic_struct_huc3b1a72eb14e80f86cf6e779c6ca28c2_3620_1024x0_resize_box_3.png 1024w" loading=lazy alt="Basic Structure" class=gallery-image data-flex-grow=184 data-flex-basis=443px></p><p>We will start implementing the same in the following snippets:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GenerateSnapshot</span><span class=p>(</span><span class=nx>listenerName</span><span class=p>,</span> <span class=nx>routeName</span><span class=p>,</span> <span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>listenerPort</span><span class=p>,</span> <span class=nx>upstreamPort</span> <span class=kt>uint32</span><span class=p>)</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Snapshot</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewSnapshot</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// endpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// clusters
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{</span><span class=nf>makeCluster</span><span class=p>(</span><span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span><span class=p>,</span> <span class=nx>upstreamPort</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// routes
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{</span><span class=nf>makeRoute</span><span class=p>(</span><span class=nx>routeName</span><span class=p>,</span> <span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// listeners
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{</span><span class=nf>makeListener</span><span class=p>(</span><span class=nx>listenerName</span><span class=p>,</span> <span class=nx>routeName</span><span class=p>,</span> <span class=nx>listenerPort</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// runtimes
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=c1>// secrets
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>[]</span><span class=nx>types</span><span class=p>.</span><span class=nx>Resource</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we implement the methods <code>makeCluster</code>, <code>makeRoute</code>, <code>makeListener</code>:</p><h3 id=cluster-and-endpoint>Cluster and Endpoint</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cluster</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/config/cluster/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/golang/protobuf/ptypes&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>core</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/config/core/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpoint</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/config/endpoint/v3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeCluster</span><span class=p>(</span><span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>upstreamPort</span> <span class=kt>uint32</span><span class=p>)</span> <span class=o>*</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Name</span><span class=p>:</span>           <span class=nx>clusterName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ConnectTimeout</span><span class=p>:</span> <span class=nx>ptypes</span><span class=p>.</span><span class=nf>DurationProto</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>ClusterDiscoveryType</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster_Type</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Type</span><span class=p>:</span> <span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster_LOGICAL_DNS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>LbPolicy</span><span class=p>:</span>        <span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster_ROUND_ROBIN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LoadAssignment</span><span class=p>:</span>  <span class=nf>makeEndpoint</span><span class=p>(</span><span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span><span class=p>,</span> <span class=nx>upstreamPort</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>DnsLookupFamily</span><span class=p>:</span> <span class=nx>cluster</span><span class=p>.</span><span class=nx>Cluster_V4_ONLY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeEndpoint</span><span class=p>(</span><span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>upstreamPort</span> <span class=kt>uint32</span><span class=p>)</span> <span class=o>*</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>ClusterLoadAssignment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>ClusterLoadAssignment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ClusterName</span><span class=p>:</span> <span class=nx>clusterName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Endpoints</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>LocalityLbEndpoints</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>LbEndpoints</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>LbEndpoint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>HostIdentifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>LbEndpoint_Endpoint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>Endpoint</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>Address</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>Address</span><span class=p>{</span>
</span></span><span class=line><span class=cl>									<span class=nx>Address</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>Address_SocketAddress</span><span class=p>{</span>
</span></span><span class=line><span class=cl>										<span class=nx>SocketAddress</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress</span><span class=p>{</span>
</span></span><span class=line><span class=cl>											<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress_TCP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>											<span class=nx>Address</span><span class=p>:</span>  <span class=nx>upstreamHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>											<span class=nx>PortSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress_PortValue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>												<span class=nx>PortValue</span><span class=p>:</span> <span class=nx>upstreamPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>											<span class=p>},</span>
</span></span><span class=line><span class=cl>										<span class=p>},</span>
</span></span><span class=line><span class=cl>									<span class=p>},</span>
</span></span><span class=line><span class=cl>								<span class=p>},</span>
</span></span><span class=line><span class=cl>							<span class=p>},</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=route>Route</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeRoute</span><span class=p>(</span><span class=nx>routeName</span><span class=p>,</span> <span class=nx>clusterName</span><span class=p>,</span> <span class=nx>upstreamHost</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteConfiguration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteConfiguration</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Name</span><span class=p>:</span> <span class=nx>routeName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>VirtualHosts</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>route</span><span class=p>.</span><span class=nx>VirtualHost</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span>    <span class=s>&#34;local_service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Domains</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;*&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=nx>Routes</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>route</span><span class=p>.</span><span class=nx>Route</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>Match</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteMatch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>PathSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteMatch_Prefix</span><span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>Prefix</span><span class=p>:</span> <span class=s>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=p>},</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>						<span class=nx>Action</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>Route_Route</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>Route</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteAction</span><span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>ClusterSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteAction_Cluster</span><span class=p>{</span>
</span></span><span class=line><span class=cl>									<span class=nx>Cluster</span><span class=p>:</span> <span class=nx>clusterName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>								<span class=p>},</span>
</span></span><span class=line><span class=cl>								<span class=nx>HostRewriteSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>route</span><span class=p>.</span><span class=nx>RouteAction_HostRewriteLiteral</span><span class=p>{</span>
</span></span><span class=line><span class=cl>									<span class=nx>HostRewriteLiteral</span><span class=p>:</span> <span class=nx>upstreamHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>								<span class=p>},</span>
</span></span><span class=line><span class=cl>							<span class=p>},</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=listener-connection-manager-and-config-source>Listener, connection manager and config source</h3><p>This is probably the most complicated one â€“ but will conform to the structure we defined in the <a class=link href=https://ishankhare.dev/posts/8/#dynamic_config target=_blank rel=noopener>previous article&rsquo;s dynamic listerner config</a> â€“ the only difference being it was in <code>yaml</code> and this is in pure <code>go</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>core</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/config/core/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>listener</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/config/listener/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>hcm</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/extensions/filters/network/http_connection_manager/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/cache/types&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/cache/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/resource/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/wellknown&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/golang/protobuf/ptypes&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeListener</span><span class=p>(</span><span class=nx>listenerName</span><span class=p>,</span> <span class=nx>routeName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>listenerPort</span> <span class=kt>uint32</span><span class=p>)</span> <span class=o>*</span><span class=nx>listener</span><span class=p>.</span><span class=nx>Listener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>manager</span> <span class=o>:=</span> <span class=nf>makeHTTPConnManager</span><span class=p>(</span><span class=nx>routeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>typedConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ptypes</span><span class=p>.</span><span class=nf>MarshalAny</span><span class=p>(</span><span class=nx>manager</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>listener</span><span class=p>.</span><span class=nx>Listener</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Name</span><span class=p>:</span> <span class=nx>listenerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Address</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>Address</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Address</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>Address_SocketAddress</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>SocketAddress</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress_TCP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Address</span><span class=p>:</span>  <span class=s>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>PortSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>SocketAddress_PortValue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>PortValue</span><span class=p>:</span> <span class=nx>listenerPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>FilterChains</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>listener</span><span class=p>.</span><span class=nx>FilterChain</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Filters</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>listener</span><span class=p>.</span><span class=nx>Filter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>Name</span><span class=p>:</span> <span class=nx>wellknown</span><span class=p>.</span><span class=nx>HTTPConnectionManager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>ConfigType</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>listener</span><span class=p>.</span><span class=nx>Filter_TypedConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>TypedConfig</span><span class=p>:</span> <span class=nx>typedConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeHTTPConnManager</span><span class=p>(</span><span class=nx>routeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>hcm</span><span class=p>.</span><span class=nx>HttpConnectionManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>hcm</span><span class=p>.</span><span class=nx>HttpConnectionManager</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>CodecType</span><span class=p>:</span>  <span class=nx>hcm</span><span class=p>.</span><span class=nx>HttpConnectionManager_AUTO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>StatPrefix</span><span class=p>:</span> <span class=s>&#34;http&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// AccessLog: []*accesslog.AccessLog{
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 	{
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 		Name:       &#34;envoy.access_loggers.stdout&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 		ConfigType: &amp;accesslog.AccessLog_TypedConfig{},
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 	},
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// },
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>RouteSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>hcm</span><span class=p>.</span><span class=nx>HttpConnectionManager_Rds</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Rds</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>hcm</span><span class=p>.</span><span class=nx>Rds</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ConfigSource</span><span class=p>:</span>    <span class=nf>makeConfigSource</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>RouteConfigName</span><span class=p>:</span> <span class=nx>routeName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>HttpFilters</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>hcm</span><span class=p>.</span><span class=nx>HttpFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span> <span class=nx>wellknown</span><span class=p>.</span><span class=nx>Router</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makeConfigSource</span><span class=p>()</span> <span class=o>*</span><span class=nx>core</span><span class=p>.</span><span class=nx>ConfigSource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>source</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>ConfigSource</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>source</span><span class=p>.</span><span class=nx>ResourceApiVersion</span> <span class=p>=</span> <span class=nx>resource</span><span class=p>.</span><span class=nx>DefaultAPIVersion</span>
</span></span><span class=line><span class=cl>	<span class=nx>source</span><span class=p>.</span><span class=nx>ConfigSourceSpecifier</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>ConfigSource_ApiConfigSource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ApiConfigSource</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>ApiConfigSource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>TransportApiVersion</span><span class=p>:</span>       <span class=nx>resource</span><span class=p>.</span><span class=nx>DefaultAPIVersion</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ApiType</span><span class=p>:</span>                   <span class=nx>core</span><span class=p>.</span><span class=nx>ApiConfigSource_GRPC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>SetNodeOnFirstMessageOnly</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>GrpcServices</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>core</span><span class=p>.</span><span class=nx>GrpcService</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>TargetSpecifier</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>GrpcService_EnvoyGrpc_</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>EnvoyGrpc</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>core</span><span class=p>.</span><span class=nx>GrpcService_EnvoyGrpc</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>ClusterName</span><span class=p>:</span> <span class=s>&#34;xds_cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>source</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So far what we&rsquo;ve managed to do is to:</p><ol><li>Define our whole configuration in Go using the envoy&rsquo;s <code>go-control-plane</code> library</li><li>Wrap that configuration in an envoy <code>Snapshot</code></li></ol><p>With one more call we can wrap this <code>Snapshot</code> inside a <code>SnapshotCache</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>snapshotCache</span> <span class=p>=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewSnapshotCache</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>IDHash</span><span class=p>{},</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>snapshot</span><span class=p>.</span><span class=nf>GenerateSnapshot</span><span class=p>(</span><span class=s>&#34;listener_0&#34;</span><span class=p>,</span> <span class=s>&#34;local_route&#34;</span><span class=p>,</span> <span class=s>&#34;example_cluster&#34;</span><span class=p>,</span> <span class=s>&#34;www.envoyproxy.io&#34;</span><span class=p>,</span> <span class=mi>10000</span><span class=p>,</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>snapshotCache</span><span class=p>.</span><span class=nf>SetSnapshot</span><span class=p>(</span><span class=s>&#34;test-id&#34;</span><span class=p>,</span> <span class=nx>snapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;snapshot error %q for %+v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This is pretty simple â€“ with all that we&rsquo;ve already written above in our <code>makeCluster</code>, <code>makeRoute</code>, <code>makeListener</code> methods, we are basically defining:</p><ol><li>A <code>listener</code> name <code>listener_0</code></li><li>A <code>route</code> named <code>local_route</code></li><li>A <code>cluster</code> named <code>example_cluster</code></li><li>An upstream <code>host</code> which is <code>www.envoyproxy.io</code></li><li><code>Listener</code> port <code>10000</code></li><li><code>Upstream</code> port <code>80</code></li></ol><p>This should mean that this configuration should create a <code>listener</code> binding to port <code>10000</code> and proxying to <a class=link href=https://www.envoyproxy.io target=_blank rel=noopener>www.envoyproxy.io</a> on port <code>80</code></p><p>The last line is the method <code>SetSnapshot</code> where we tell the <code>SnapshotCache</code> of the active <code>snapshot</code> in the cache and the name of that snapshot.</p><h3 id=setting-up-the-grpc-services>Setting up the gRPC services</h3><p>Since in this post we are talking about dynamic serving of envoy through the xDS control plane, the gRPC protocol forms the basis of how this configuration will be served to the envoy proxies. So lets set that up now:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>clusterservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/cluster/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>discoverygrpc</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/discovery/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/endpoint/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>listenerservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/listener/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>routeservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/route/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>runtimeservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/runtime/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>secretservice</span> <span class=s>&#34;github.com/envoyproxy/go-control-plane/envoy/service/secret/v3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>generator</span> <span class=s>&#34;github.com/ishankhare07/envoy-dynamic/pkg/snapshot&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ishankhare07/envoy-dynamic/pkg/logger&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/cache/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/server/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/envoyproxy/go-control-plane/pkg/test/v3&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>log</span> <span class=o>*</span><span class=nx>logger</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>snapshotCache</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SnapshotCache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>logger</span><span class=p>.</span><span class=nx>Logger</span><span class=p>{</span><span class=nx>Debug</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RunServer</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>port</span> <span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>snapshotCache</span> <span class=p>=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewSnapshotCache</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>IDHash</span><span class=p>{},</span> <span class=nx>log</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>generator</span><span class=p>.</span><span class=nf>GenerateSnapshot</span><span class=p>(</span><span class=s>&#34;listener_0&#34;</span><span class=p>,</span> <span class=s>&#34;local_route&#34;</span><span class=p>,</span> <span class=s>&#34;example_cluster&#34;</span><span class=p>,</span> <span class=s>&#34;www.envoyproxy.io&#34;</span><span class=p>,</span> <span class=mi>10000</span><span class=p>,</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>snapshot</span><span class=p>.</span><span class=nf>Consistent</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;snapshot inconsistency: %+v\n%+v&#34;</span><span class=p>,</span> <span class=nx>snapshot</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>MarshalIndent</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;  &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Debugf</span><span class=p>(</span><span class=s>&#34;will serve snapshot %s&#34;</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Add the snapshot to the cache
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>snapshotCache</span><span class=p>.</span><span class=nf>SetSnapshot</span><span class=p>(</span><span class=s>&#34;test-id&#34;</span><span class=p>,</span> <span class=nx>snapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;snapshot error %q for %+v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cb</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>test</span><span class=p>.</span><span class=nx>Callbacks</span><span class=p>{</span><span class=nx>Debug</span><span class=p>:</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Debug</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>srv</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>snapshotCache</span><span class=p>,</span> <span class=nx>cb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>registerServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloworldservice</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>helloworldservice</span><span class=p>.</span><span class=nf>NewHelloWorldServer</span><span class=p>(</span><span class=nx>snapshotCache</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>reflection</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;management server listening on port %d\n&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>registerServer</span><span class=p>(</span><span class=nx>grpcServer</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span><span class=p>,</span> <span class=nx>server</span> <span class=nx>server</span><span class=p>.</span><span class=nx>Server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// register services
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>discoverygrpc</span><span class=p>.</span><span class=nf>RegisterAggregatedDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointservice</span><span class=p>.</span><span class=nf>RegisterEndpointDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>clusterservice</span><span class=p>.</span><span class=nf>RegisterClusterDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>routeservice</span><span class=p>.</span><span class=nf>RegisterRouteDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>listenerservice</span><span class=p>.</span><span class=nf>RegisterListenerDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>secretservice</span><span class=p>.</span><span class=nf>RegisterSecretDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>runtimeservice</span><span class=p>.</span><span class=nf>RegisterRuntimeDiscoveryServiceServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So our previously posted diagram becomes something like this</p><p><img src=/p/dabbling-with-envoy-configurations-part-ii/struct.png width=501 height=271 srcset="/p/dabbling-with-envoy-configurations-part-ii/struct_huc16f54ebba6e792ed02f3da41e36e9f6_14189_480x0_resize_box_3.png 480w, /p/dabbling-with-envoy-configurations-part-ii/struct_huc16f54ebba6e792ed02f3da41e36e9f6_14189_1024x0_resize_box_3.png 1024w" loading=lazy alt=Struct class=gallery-image data-flex-grow=184 data-flex-basis=443px></p><p>Lets make sure we serve this!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>aggregateGRPCServer</span> <span class=s>&#34;github.com/ishankhare07/envoy-dynamic/pkg/server&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>aggregateGRPCServer</span><span class=p>.</span><span class=nf>RunServer</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>18000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So our <code>xDS</code> server will be serving configuration on port <code>18000</code>, and according to the configuration <code>listener_0</code> will be binding and proxying on <code>localhost:10000</code> to <code>www.envoyproxy.io:80</code></p><h3 id=running-the-envoy-proxy>Running the envoy proxy</h3><p>Since we are serving the config from xDS control plane this time, does that mean we don&rsquo;t need to write any <code>static_configuration</code> now?
Unfortunately NO! â€“ We still need to tell envoy where the dynamic configuration is being server at. The main flexibiliy that this control plane mode is allowing us is to programatically control the configuration â€“ something that we&rsquo;ll explore soon in the following blog posts of this series. but for now we still need to write some basic envoy config:
envoy-dynamic-control-plane.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>node</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>test-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>test-id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dynamic_resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ads_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>api_type</span><span class=p>:</span><span class=w> </span><span class=l>GRPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>transport_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>grpc_services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envoy_grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cluster_name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cds_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ads</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lds_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ads</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>static_resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>STRICT_DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>typed_extension_protocol_options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;@type&#34;: </span><span class=l>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>explicit_http_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>http2_protocol_options</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http2_protocol_options</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connect_timeout</span><span class=p>:</span><span class=w> </span><span class=l>3s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>load_assignment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cluster_name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lb_endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>socket_address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port_value</span><span class=p>:</span><span class=w> </span><span class=m>18000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>admin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>access_log_path</span><span class=p>:</span><span class=w> </span><span class=l>/dev/null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>socket_address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port_value</span><span class=p>:</span><span class=w> </span><span class=m>19000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>layered_runtime</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>layers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>runtime-0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rtds_layer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>rtds_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resource_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>api_config_source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>transport_api_version</span><span class=p>:</span><span class=w> </span><span class=l>V3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>api_type</span><span class=p>:</span><span class=w> </span><span class=l>GRPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>grpc_services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>envoy_grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>cluster_name</span><span class=p>:</span><span class=w> </span><span class=l>xds_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>runtime-0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Interesting parts are:</p><ol><li><code>dynamic_resources.ads_config</code> â€“ here we tell envoy to:<ul><li>Expect a GRPC configuration</li><li>Conforming to V3 of the envoy api</li><li>Served by a envoy <code>cluster</code> named <code>xds_cluster</code> â€“ where would envoy find <code>xds_cluster</code> now? Read along</li></ul></li><li><code>static_resources.clusters[0].name</code> â€“ answer to your question above</li><li><code>static_resources.clusters[0].endpoints</code> â€“ what endpoints to expect in this cluster (basically the <code>host</code> and <code>port</code> of our gRPC <code>xDS</code> server serving the dynamic configuration)</li></ol><p>Here&rsquo;s what things look like now</p><p><img src=/p/dabbling-with-envoy-configurations-part-ii/final_struct.png width=791 height=457 srcset="/p/dabbling-with-envoy-configurations-part-ii/final_struct_hu3c015df7e055c2ec8609eb1c04b2b67e_60012_480x0_resize_box_3.png 480w, /p/dabbling-with-envoy-configurations-part-ii/final_struct_hu3c015df7e055c2ec8609eb1c04b2b67e_60012_1024x0_resize_box_3.png 1024w" loading=lazy alt="Final Struct" class=gallery-image data-flex-grow=173 data-flex-basis=415px></p><h3 id=running-everything>Running everything</h3><p>If you&rsquo;ve followed along till now, here&rsquo;s the reward. Lets run the control plane and the envoy server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># in one shell let&#39;s start the control plane</span>
</span></span><span class=line><span class=cl>go run main.go
</span></span><span class=line><span class=cl>2022/01/14 03:11:48 will serve snapshot <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Resources&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;example_cluster&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Resource&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;example_cluster&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ClusterDiscoveryType&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;Type&#34;</span>: <span class=m>2</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;connect_timeout&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;seconds&#34;</span>: <span class=m>5</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;load_assignment&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;cluster_name&#34;</span>: <span class=s2>&#34;example_cluster&#34;</span>,
</span></span><span class=line><span class=cl>              <span class=s2>&#34;endpoints&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;lb_endpoints&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                    <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=s2>&#34;HostIdentifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Endpoint&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                          <span class=s2>&#34;address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;Address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                              <span class=s2>&#34;SocketAddress&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;www.envoyproxy.io&#34;</span>,
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;PortSpecifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                                  <span class=s2>&#34;PortValue&#34;</span>: <span class=m>80</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                              <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                          <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                  <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>              <span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dns_lookup_family&#34;</span>: 1,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;LbConfig&#34;</span>: null
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Ttl&#34;</span>: null
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;local_route&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Resource&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;local_route&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;virtual_hosts&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;local_service&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;domains&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;routes&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                  <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=s2>&#34;PathSpecifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Prefix&#34;</span>: <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=s2>&#34;Route&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ClusterSpecifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                          <span class=s2>&#34;Cluster&#34;</span>: <span class=s2>&#34;example_cluster&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;HostRewriteSpecifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                          <span class=s2>&#34;HostRewriteLiteral&#34;</span>: <span class=s2>&#34;www.envoyproxy.io&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Ttl&#34;</span>: null
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;listener_0&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Resource&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;listener_0&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;Address&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;SocketAddress&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;0.0.0.0&#34;</span>,
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;PortSpecifier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;PortValue&#34;</span>: <span class=m>10000</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;filter_chains&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;filters&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                  <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;ConfigType&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=s2>&#34;TypedConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type_url&#34;</span>: <span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;EgRodHRwKhsKGWVudm95LmZpbHRlcnMuaHR0cC5yb3V0ZXIaKgobMAISFwgCIg8KDQoLeGRzX2NsdXN0ZXI4AUACEgtsb2NhbF9yb3V0ZQ==&#34;</span>
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ListenerSpecifier&#34;</span>: null
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;Ttl&#34;</span>: null
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;1&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Items&#34;</span>: <span class=o>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;VersionMap&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>2022/01/14 03:11:48 management server listening on port <span class=m>18000</span>
</span></span></code></pre></td></tr></table></div></div><p>We are spitting out the served <code>xDS</code> configuration for convenience. Lets start the envoy server in another terminal with the previously defined configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>envoy -c envoy-dynamic-control-plane.yaml -l debug
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl><span class=o>[</span>2022-01-14 03:14:28.280<span class=o>][</span>4602226<span class=o>][</span>debug<span class=o>][</span>router<span class=o>]</span> <span class=o>[</span>source/common/router/router.cc:486<span class=o>]</span> <span class=o>[</span>C0<span class=o>][</span>S9032965470346210647<span class=o>]</span> cluster <span class=s1>&#39;xds_cluster&#39;</span> match <span class=k>for</span> URL <span class=s1>&#39;/envoy.service.discovery.v3.AggregatedDiscoveryServic
</span></span></span><span class=line><span class=cl><span class=s1>e/StreamAggregatedResources&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2022-01-14 03:14:28.280<span class=o>][</span>4602226<span class=o>][</span>debug<span class=o>][</span>router<span class=o>]</span> <span class=o>[</span>source/common/router/router.cc:702<span class=o>]</span> <span class=o>[</span>C0<span class=o>][</span>S9032965470346210647<span class=o>]</span> router decoding headers:
</span></span><span class=line><span class=cl><span class=s1>&#39;:method&#39;</span>, <span class=s1>&#39;POST&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;:path&#39;</span>, <span class=s1>&#39;/envoy.service.discovery.v3.AggregatedDiscoveryService/StreamAggregatedResources&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;:authority&#39;</span>, <span class=s1>&#39;xds_cluster&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;:scheme&#39;</span>, <span class=s1>&#39;http&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;te&#39;</span>, <span class=s1>&#39;trailers&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;content-type&#39;</span>, <span class=s1>&#39;application/grpc&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;x-envoy-internal&#39;</span>, <span class=s1>&#39;true&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;x-forwarded-for&#39;</span>, <span class=s1>&#39;192.168.29.160&#39;</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>.
</span></span></code></pre></td></tr></table></div></div><p>There will be lots of information but the one I&rsquo;ve pasted above confirms that envoy was able to find the xds_cluster serving our configuration. Also if we go and look at the <code>control_plane</code> terminal, we&rsquo;ll find this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>2022/01/14 03:14:27 stream <span class=m>1</span> open <span class=k>for</span> type.googleapis.com/envoy.service.runtime.v3.Runtime
</span></span><span class=line><span class=cl>2022/01/14 03:14:27 respond type.googleapis.com/envoy.service.runtime.v3.Runtime<span class=o>[</span>runtime-0<span class=o>]</span> version <span class=s2>&#34;&#34;</span> with version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:27 open watch <span class=m>1</span> <span class=k>for</span> type.googleapis.com/envoy.service.runtime.v3.Runtime<span class=o>[</span>runtime-0<span class=o>]</span> from nodeID <span class=s2>&#34;test-id&#34;</span>, version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:28 stream <span class=m>2</span> open <span class=k>for</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:42 respond type.googleapis.com/envoy.config.cluster.v3.Cluster<span class=o>[]</span> version <span class=s2>&#34;&#34;</span> with version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:42 open watch <span class=m>2</span> <span class=k>for</span> type.googleapis.com/envoy.config.cluster.v3.Cluster<span class=o>[]</span> from nodeID <span class=s2>&#34;test-id&#34;</span>, version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:43 respond type.googleapis.com/envoy.config.listener.v3.Listener<span class=o>[]</span> version <span class=s2>&#34;&#34;</span> with version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:43 stream <span class=m>3</span> open <span class=k>for</span> type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span class=line><span class=cl>2022/01/14 03:14:43 open watch <span class=m>3</span> <span class=k>for</span> type.googleapis.com/envoy.config.listener.v3.Listener<span class=o>[]</span> from nodeID <span class=s2>&#34;test-id&#34;</span>, version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:43 respond type.googleapis.com/envoy.config.route.v3.RouteConfiguration<span class=o>[</span>local_route<span class=o>]</span> version <span class=s2>&#34;&#34;</span> with version <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>2022/01/14 03:14:43 open watch <span class=m>4</span> <span class=k>for</span> type.googleapis.com/envoy.config.route.v3.RouteConfiguration<span class=o>[</span>local_route<span class=o>]</span> from nodeID <span class=s2>&#34;test-id&#34;</span>, version <span class=s2>&#34;1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s test by visiting http://localhost:10000 â€“ on clicking this link you should be redirected to <a class=link href=https://www.envoyproxy.io target=_blank rel=noopener>www.envoyproxy.io</a>:80</p><p><img src=/p/dabbling-with-envoy-configurations-part-ii/Screenshot_2022-01-14_at_03-21-02_Envoy_Proxy_-_Home.png width=2880 height=1376 srcset="/p/dabbling-with-envoy-configurations-part-ii/Screenshot_2022-01-14_at_03-21-02_Envoy_Proxy_-_Home_hu0275baba04f54894bddf5f1b2a4a0162_117235_480x0_resize_box_3.png 480w, /p/dabbling-with-envoy-configurations-part-ii/Screenshot_2022-01-14_at_03-21-02_Envoy_Proxy_-_Home_hu0275baba04f54894bddf5f1b2a4a0162_117235_1024x0_resize_box_3.png 1024w" loading=lazy alt="Envoy Proxy - Home" class=gallery-image data-flex-grow=209 data-flex-basis=502px></p><p>And there you have it!</p><p>If you would like to see the whole repo and code better organized that this blog post, head ove to this github repo â€“ github.com/ishankhare07/envoy-dynamic</p><h3 id=what-next>What next?!</h3><p>Continuing my habbit of fiddling with all kinds of things, I&rsquo;ve decided to convert this already long 2 part series of posts even longer. The goal is to start from envoy basics already discussed in the past and the current post and going all the way up to a very curde service mesh implementation. In the coming days I would be covering more of the following topics:</p><ol><li>Dynamically adding more upstreams to our control plane through an exposed gRPC endpoint.</li><li>Write a <code>sidecar</code> injector that is able to inject envoy proxies into our k8s pods</li><li>Serve control plane inside k8s cluster with the <code>sidecar</code> injector enabled</li><li>Make the envoy sidecars fetch the dynamic configuration from the in-cluster control plane and proxy few upstreams.</li><li>Wrap the control plane in a k8s controller and use a CRD to add / remove upstreams</li><li>Proxy <code>Pod</code>-to-<code>Pod</code> communication and updating the upstream configuration using the k8s controller.</li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/envoy/>Envoy</a>
<a href=/tags/reverseproxy/>Reverseproxy</a>
<a href=/tags/servicemesh/>Servicemesh</a>
<a href=/tags/istio/>Istio</a>
<a href=/tags/golang/>Golang</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>MIT</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jan 14, 2022 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/dabbling-with-envoy-configurations-part-i/><div class=article-image><img src=/p/dabbling-with-envoy-configurations-part-i/cover.ab2922c12ee2c473d63c2ef426b575cf_huca0165527005b89d1a6b5500db0bdef1_3693180_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Dabbling with Envoy configurations - Part I" data-key=dabbling-with-envoy-configurations-part-I data-hash="md5-qykiwS7ixHPWPC70JrV1zw=="></div><div class=article-details><h2 class=article-title>Dabbling with Envoy configurations - Part I</h2></div></a></article><article class=has-image><a href=/p/teaching-kubernetes-service-mesh-tricks/><div class=article-image><img src=/p/teaching-kubernetes-service-mesh-tricks/brahmaputra.9d5d5b9a9e1f907a0430af1faf17399f_huc7cb4a692ba86d21dca6ace88275abce_1697843_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Teaching kubernetes service mesh tricks" data-key=teaching-kubernetes-service-mesh-tricks data-hash="md5-nV1bmp4fkHoEMK8frxc5nw=="></div><div class=article-details><h2 class=article-title>Teaching kubernetes service mesh tricks</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Ishan Khare</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>